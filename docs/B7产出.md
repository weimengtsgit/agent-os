## 1️⃣ 本轮产出摘要（B7）

1. 给出 **生产化目标**：稳定可控、可隔离、可审计、可运营，支持多团队长期运行
2. 明确 **发布流水线**：Agent / Prompt / Tool / Policy 的版本化、灰度、回滚
3. 设计 **运行时隔离与稳定性机制**：并发、限流、取消、熔断、背压
4. 完整覆盖 **安全与合规**：权限、审计、脱敏、密钥、供应链
5. 建立 **成本治理与 SLO**：单位任务成本、预算、告警
6. 输出 **事故预案与 Runbook**：从检测到复盘的闭环
7. 给出 **从 B6 → B7 的实施顺序**（避免“先上生产再补治理”）

---

## 2️⃣ 可执行 TODO 清单（P0 / P1 / P2，≥12）

### P0（敢上生产的最低门槛）

1. 建立 **发布流水线**：Spec 校验 → 合约测试 → 灰度发布 → 回滚
2. 实现 **运行时并发控制**（Agent/Team/Global 三级）
3. 实现 **Run 级取消与超时**（强制中断工具与 LLM 调用）
4. 实现 **工具级熔断**（连续失败阈值 + 冷却时间）
5. 落地 **审计日志**（Run/Tool/Policy/Human Review 全覆盖）
6. 实现 **密钥管理**（Secrets 不进 Spec/Repo）
7. 建立 **成本统计口径**（token/cost/duration 统一）

### P1（生产稳定性增强）

8. 建立 **SLO/告警**（成功率、P95、成本异常）
9. 实现 **灰度路由**（stage=canary 权重或白名单）
10. 引入 **数据脱敏/输出过滤**（Policy + Redaction）
11. 建立 **变更影响评估**（新版本对比旧版本）
12. 建立 **回放与定位工具**（Run 回放 + 关键指标）

### P2（规模化与合规增强）

13. 多租户（tenant）与资源配额
14. 合规模板（PII/日志保留期/地域）
15. 供应链安全（依赖扫描、镜像签名）
16. 灾备与容量规划

---

## 3️⃣ 生产发布流水线（Agent / Prompt / Tool / Policy）

### 3.1 发布对象与原则

* **对象**：AgentSpec、ToolSpec、PolicySpec、Prompt（版本化资源）
* **原则**：

  * 版本不可变（immutable）
  * 发布与运行解耦
  * 回滚 = 路由回退（不删版本）

### 3.2 流水线步骤（必做）

1. **PR 校验**：Schema Validate + Unit Tests
2. **合约测试**：固定输入 → 事件序列/关键字段稳定
3. **影子运行（可选）**：同输入跑新旧版本，对比结果
4. **发布到 Registry**：状态=active(dev)
5. **灰度**：stage=canary（白名单/比例）
6. **晋升 prod**：SLO 达标 + 人工确认
7. **回滚**：Registry 指回旧 version（即时生效）

---

## 4️⃣ 稳定性与隔离设计（Runtime）

### 4.1 并发与限流（三级）

* **Global**：平台总并发上限
* **Team**：每团队并发/速率
* **Agent**：单 Agent 并发、队列深度

**实现建议**

* MVP：进程内 Semaphore + 队列
* 演进：分布式限流（Redis/Sidecar）

### 4.2 取消、超时、背压

* **Run 级 timeout**：来自 AgentSpec.limits.timeoutMs
* **Tool 级 timeout**：来自 ToolSpec.timeoutMs
* **取消传播**：`run_cancel` → 中断 LLM/Tool → 释放资源
* **背压**：队列满直接拒绝（记录事件）

### 4.3 熔断与重试

* **Tool 熔断**：

  * N 次失败 → open → 冷却 → half-open
* **LLM 重试**：

  * 网络/限流可重试
  * 语义错误不重试

---

## 5️⃣ 安全与合规（Security & Compliance）

### 5.1 权限与最小权限

* **Agent 权限**：能用哪些 Tool / Model
* **Tool 权限**：能访问哪些数据域
* **Actor 权限**：谁能触发/审批/查看

> 实现：PolicySpec + PolicyEngine（allow/deny 事件）

### 5.2 审计（必须可追溯）

* 覆盖：

  * Agent 启动/取消
  * Tool 调用（输入摘要）
  * 人审决策
  * Policy 决策
* 要求：**不可篡改**、**可导出**

### 5.3 数据脱敏与输出过滤

* **输入**：Tool 返回前脱敏（PII）
* **输出**：LLM 输出正则/规则过滤
* **事件**：避免全量敏感数据落盘

### 5.4 密钥管理

* Secrets 通过：

  * 本地：env / keyring
  * 生产：KMS / Vault
* **禁止**：Spec/Repo/日志中出现密钥

---

## 6️⃣ 成本治理与 SLO

### 6.1 成本模型

* 维度：Agent / Version / Team / Run
* 指标：promptTokens、completionTokens、totalTokens、cost、duration

### 6.2 预算与限额

* **软限额**：告警
* **硬限额**：拒绝新 Run（记录事件）

### 6.3 SLO（示例）

* 成功率 ≥ 99%
* P95 耗时 ≤ 30s（对话型）
* 单 Run 成本 ≤ $X

---

## 7️⃣ 事故预案与 Runbook（生产必备）

### 7.1 常见事故与处置

1. **Agent 大量失败**

   * 动作：降级（停用新 Run）→ 回滚版本 → 分析 run_error

2. **成本异常飙升**

   * 动作：冻结 Agent → 降级模型 → 检查 prompt/tool 循环

3. **外部工具雪崩**

   * 动作：熔断 Tool → 启用降级路径 → 通知 Owner

### 7.2 Runbook 要素

* 触发条件
* 影响范围
* 操作步骤（CLI/Console）
* 回滚方式
* 复盘指标

---

## 8️⃣ 从 B6 → B7 的实施顺序（强烈建议）

1. 先给 **测试用例生成 Agent** 上发布流水线
2. 打开并发/限流/取消
3. 上审计与成本统计
4. 定义 SLO 与告警
5. 再开放更多业务 Agent 上生产

👉 **不要**在多 Agent 未受控前就全量开放生产入口。

---

## 9️⃣ 风险与回滚方案（≥3）

1. **风险：过度工程化拖慢上线**

   * 回滚：P0 只做必要项，其余 Feature Flag

2. **风险：成本失控**

   * 回滚：默认限额 + 强告警 + 手动审批

3. **风险：安全策略过严影响业务**

   * 回滚：Policy 分 stage（dev/canary/prod）逐步收紧

4. **风险：事故定位困难**

   * 回滚：强制 events.jsonl + Run 回放

---

## 🔟 下一轮输入要求（B8）

请直接发：

> **B8：解耦与迁移策略（避免被 runtime 锁死）**

我会给你：

* 稳定不变的“平台契约层”清单
* PAL 的 Adapter/Contract Tests 完整策略
* **从 agno 切换/并存其它 runtime 的演练方案（GameDay）**
* 数据迁移与双跑策略（不中断生产）

如果你接下来要 **运行在 K8s、多团队共用集群**，在 B8 后面加一句这句话，我会把调度/隔离/配额模型一起给出来。
